#   ansible-playbook create_user.yml -i ubuntu@<host>, --extra-vars '{"user_password": "PASSWORD"}'
---
- name: create user
  hosts: '*'
  become: true
  vars:
  - user: smutch

  tasks:
  - name: install zsh
    apt:
      update_cache: yes
      name: zsh
      state: present

  - name: create user
    ansible.builtin.user:
      name: '{{ user }}'
      group: sudo
      password: "{{ user_password | password_hash('sha512') }}"
      update_password: on_create
      shell: /bin/zsh
    become_user: root

  - name: Set authorized key taken from file
    ansible.posix.authorized_key:
      user: '{{ user }}'
      state: present
      key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
